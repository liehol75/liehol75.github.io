<!-- PART 1/3: Kopf (DOCTYPE, <head>, CSS) -->
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GolfGag-Gadget</title>
<style>
/* Grundlayout (leicht angepasst und erweitert) */
body {
  font-family: 'Segoe UI', Tahoma, sans-serif;
  margin: 0;
  background: linear-gradient(135deg,#e6f2ff,#f7faff);
  color: #333;
}
header { padding: 30px; text-align:center; }
h1 { margin:0 0 10px; font-size:2.4em; color:#2b7cff; }

/* Buttons */
button {
  background:#2b7cff; color:#fff; border:none;
  padding:12px 20px; margin:10px; border-radius:8px;
  font-size:1.2em; cursor:pointer; transition:background .2s;
}
button:hover { background:#1b5fcc; }

/* Inputs / Selects */
input, select {
  padding:10px; margin:10px 0; font-size:1.05em;
  border-radius:6px; border:1px solid #ccc;
}

/* Startseite */
#startSection { padding:40px 20px; text-align:center; }
.start-card{
  display:inline-block; background:#fff; padding:32px;
  border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.08);
}

/* Generatoren: jetzt gestapelt, getrennt und weiß gerahmt */
#generators{
  text-align:center;
  margin-bottom:30px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:18px;
}
.generator-block{
  width:320px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}
.generator-card {
  width:100%;
  background:#fff;
  border-radius:12px;
  padding:18px;
  box-shadow:0 4px 10px rgba(0,0,0,0.06);
  text-align:center;
}
/* Wenn beide Generatoren sichtbar: optische Trennung (z. B. leichter Rahmen) */
.generator-separator {
  width:80%;
  height:1px;
  background:linear-gradient(90deg, transparent, rgba(0,0,0,0.06), transparent);
  margin:6px 0;
}

/* Generator-Resultbox */
.generator-box{
  width:100%;
  min-height:48px;
  background:#fff;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  font-size:1.05em;
  border:1px solid rgba(0,0,0,0.06);
  padding:8px;
  white-space:pre-wrap;
}

/* Player Cards & Teams */
.playerCard, .teamCard {
  display:inline-block; vertical-align:top; background:#fff;
  border-radius:10px; padding:12px; margin:12px;
  min-width:260px; box-shadow:0 0 6px rgba(0,0,0,0.08);
  text-align:left;
}
.teamCard { min-width:620px; padding:14px; }

/* Team-Visual (farblich abgesetztes Rechteck für 4-Spieler Team-Modus) */
.teamWrapper {
  background: linear-gradient(180deg,#f2f7ff,#ffffff);
  border-radius:12px;
  padding:10px;
  box-shadow:0 3px 8px rgba(0,0,0,0.04);
  display:flex;
  gap:12px;
  align-items:flex-start;
  justify-content:space-between;
}

/* Placement / Option boxes */
.optionList, .placementTable {
  font-size:0.9em; margin-top:8px; background:#f9f9f9; padding:6px;
  border-radius:6px; min-height:40px;
}
.placementTable { max-height:140px; overflow-y:auto; background:#f0f4f7; }

/* Badge styles */
.badge {
  display:inline-block; padding:8px 12px; border-radius:20px;
  color:#fff; font-weight:700; min-width:80px; text-align:center;
  font-size:1.1em;
}
.up { background:#2b7cff; }
.down { background:#d9534f; }
.tied { background:#8a8a8a; }

/* helper */
.centerRow { display:flex; align-items:center; justify-content:center; gap:16px; flex-wrap:wrap; }
.sectionTitle { margin:14px 0 8px; font-weight:700; color:#234; text-align:center; }

/* Holes container: zentriert, flexible Grid */
#holes {
  display:flex;
  flex-wrap:wrap;
  gap:14px;
  justify-content:center;
  padding:12px;
}

/* Einzelne Bahn als abgerundetes weißes Rechteck */
.holeCard {
  background:#fff;
  border-radius:12px;
  padding:14px;
  width:320px;
  box-shadow:0 3px 8px rgba(0,0,0,0.06);
  text-align:center;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
}

/* Bahn-Name */
.holeTitle {
  font-weight:700;
  margin-bottom:10px;
}

/* Container für die Dropdowns, zentriert */
.holeControls {
  display:flex;
  justify-content:center;
  align-items:center;
  gap:20px; /* Standardabstand zwischen Dropdowns */
  flex-wrap:wrap;
  width:100%;
}

/* Bei 4-Spieler Einzel kleiner Abstand */
.holeControls.small-gap { gap:8px; }

/* Selects innerhalb der Bahn einheitlich */
.holeCard select {
  min-width:120px;
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:1em;
  background:transparent;
}

/* Responsive: auf schmalen Bildschirmen Dropdowns untereinander */
@media (max-width:420px){
  .holeCard { width:92%; }
  .generator-box { width:92%; }
  .generator-block { width:92%; }
}

/* Score-Quadrate für Gesamt / Bonus / Bahn-Ergebnisse */
.score-square {
  display:inline-flex;
  width:44px; height:36px;
  align-items:center; justify-content:center;
  border-radius:6px;
  border:1px solid #000;
  font-weight:700;
  margin-left:8px;
}
.score-neutral { background:#e0e0e0; color:#fff; border-color:rgba(0,0,0,0.08); } /* 0: grau, weiß text */
.score-positive { background:#2b7cff; color:#fff; border-color:transparent; }
.score-negative { background:#d9534f; color:#fff; border-color:transparent; }
.score-zero-white { background:#fff; color:#000; border-color:#000; } /* initial white */

.score-small {
  display:inline-flex;
  width:36px; height:28px;
  align-items:center; justify-content:center;
  border-radius:5px;
  font-weight:700;
  margin-left:auto;
  margin-right:0;
}

/* Hole circles for matchplay & kurzspiel (1..9 and 10..18 rows) */
.hole-row {
  display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap;
}
.hole-circle {
  width:30px; height:30px; border-radius:50%;
  display:inline-flex; align-items:center; justify-content:center;
  font-weight:700; font-size:0.9em;
  background:#fff; color:#000; border:2px solid #000;
}
.hole-circle.win { background:#2b7cff; color:#fff; border-color:transparent; }
.hole-circle.lose { background:#d9534f; color:#fff; border-color:transparent; }
.hole-circle.tie { background:#8a8a8a; color:#fff; border-color:transparent; }
.hole-circle.neutral { background:#fff; color:#000; border-color:#000; }

/* Kurzspiel score cell (abgerundetes Rechteck) */
.kurz-scorecell {
  width:36px; height:36px; border-radius:8px;
  display:inline-flex; align-items:center; justify-content:center;
  font-weight:700; border:2px solid rgba(0,0,0,0.06);
  background:#f4f7fb; color:#000;
}

/* Kurzspiel circle variants - smaller circles and centered */
.kurz-circle { width:22px; height:22px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-weight:700; border:2px solid #000; background:#fff; color:#000; font-size:0.85em; line-height:1; }
.kurz-orange { background:orange; color:#fff; border-color:transparent;}
.kurz-yellow { background:yellow; color:#000; border-color:transparent;}
.kurz-blue { background:#2b7cff; color:#fff; border-color:transparent;}
.kurz-red { background:#d9534f; color:#fff; border-color:transparent;}
.kurz-purple { background:rebeccapurple; color:#fff; border-color:transparent;}
.kurz-black { background:#000; color:#fff; border-color:transparent;}

/* zentrierte Ausrichtung für alle Modi */
#playersSection { text-align:center; display:flex; justify-content:center; align-items:flex-start; flex-wrap:wrap; gap:12px; }

/* kleinere Abstände zwischen Dropdown und Nummer für die 4-Spieler Einzel (falls benötigt) */
.small-select-label { margin-right:6px; display:inline-block; }
</style>
</head>
<body>
<!-- PART 2/3: Body - UI Struktur (Startbereich, Generators, Platz für Spieler/Holes) -->
<header>
  <h1>GolfGag-Gadget</h1>
</header>

<div id="startSection">
  <div class="start-card">
    <label>Spieleranzahl:
      <select id="playerCount" onchange="updateModeOptions()">
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
      </select>
    </label>
    <br>
    <label>Modus:
      <select id="mode"></select>
    </label>
    <br>
    <div id="parSetting" style="display:none; margin-top:8px;">
      <label>PAR für Kurzspiel-Competition:
        <input id="parValue" type="number" min="-10" max="10" value="2" />
      </label>
    </div>
    <br>
    <button onclick="startGame()">Spiel starten</button>
  </div>
</div>

<div id="game" style="display:none;">
  <div id="generators" class="section">
    <div class="generator-block">
      <div class="generator-card" id="clubGeneratorCard">
        <div><button onclick="randomClub()">?? Schläger</button></div>
        <div id="clubResultBox" class="generator-box"></div>
      </div>

      <div class="generator-separator"></div>

      <div class="generator-card" id="formGeneratorCard">
        <div><button onclick="randomForm()">?? Spielform</button></div>
        <div id="formResultBox" class="generator-box"></div>
      </div>
    </div>
  </div>

  <div id="playersSection" class="section"></div>

  <div id="holesSection" class="section">
    <h3 class="sectionTitle">Platzierungen pro Bahn</h3>
    <div id="holes"></div>
  </div>
</div>
<!-- PART 3/3: Scripts (alle JS-Funktionen, automatische Team-Auswertung, Matchplay/Kurzspiel Logik) -->
<script>
let clubs=["Driver","Holz 3","Holz 5","Hybrid","Eisen 4","Eisen 5","Eisen 6","Eisen 7","Eisen 8","Eisen 9","Pitching Wedge","Gap Wedge","Sand Wedge","Lob Wedge","Putter"];
let forms=["Zufallsschläger (Einer für die Bahn)","Zufallsschläger (für Alle)","Zufallsschläger (Luck of the draw)","Nur Eisen 7","Nur Pitching Wedge","Nur Hölzer","Von Rot","Von Gelb","Nimm 2 -Best Ball","Nimm 2 -Worst Ball","Scramble Best Ball","Scramble Worst Ball","Nur zwei Zufallsschläger","Pflicht-Fairway-/Grüntreffer","Leder Wedge","Leder Wedge Mitspieler (Grün rettet)","Mitspieler wählen Schläger"];
let options=[
  {name:"Holz getroffen",value:-1},{name:"Penalty Area",value:-1},{name:"Out of bounds",value:-1},{name:"3–Putt",value:-1},{name:"1-Putt",value:+1},{name:"Chip-In",value:+1},{name:"Birdie",value:+1},{name:"Nearest to the Pin",value:+1},{name:"Fairway verfehlt",value:-1},{name:"Green in Regulation",value:+1},{name:"PAR gerettet",value:+1},{name:"Bunker",value:-1},{name:"Sandy PAR",value:+1},{name:"Socket",value:-1},{name:"Lady",value:-1},{name:"2 Chips",value:-1},{name:"Über‘s Grün getoppt",value:-1},{name:"Doppel-PAR und mehr",value:-1},{name:"Goldene Ananas",value:-1},{name:"Luftschlag",value:-1},{name:"Leider kurz",value:-1},{name:"Schneckenficker",value:-1},{name:"Großer Schwung, kleines Ergebnis",value:-1},{name:"Luftalarm",value:-1},
  {name:"Texas Wedge", value:+1}
];

let players=[];
let optionOwner={};
let placements={};
let kurzScores = {}; // for Kurzspiel-Competition: {playerIndex: {1:score,2:score,...}}

/* MODE SELECT */
function updateModeOptions(){
  const count=parseInt(document.getElementById("playerCount").value);
  const modeSel=document.getElementById("mode");
  modeSel.innerHTML="";
  let opt=document.createElement("option");
  opt.value="einzel"; opt.textContent="Einzel"; modeSel.appendChild(opt);
  let opt2=document.createElement("option");
  opt2.value="kurz"; opt2.textContent="Kurzspiel-Competition"; modeSel.appendChild(opt2);
  if(count==4){let optTeam=document.createElement("option"); optTeam.value="team"; optTeam.textContent="Team"; modeSel.appendChild(optTeam);}
  if(count==2||count==4){let optMp=document.createElement("option"); optMp.value="matchplay"; optMp.textContent="Matchplay"; modeSel.appendChild(optMp);}
  document.getElementById("mode").onchange = function(){
    document.getElementById("parSetting").style.display = (document.getElementById("mode").value === "kurz") ? "block" : "none";
  };
  document.getElementById("mode").dispatchEvent(new Event('change'));
}

/* START / RESET */
function startGame(){
  const count=parseInt(document.getElementById("playerCount").value);
  const mode=document.getElementById("mode").value;
  players=[]; optionOwner={}; placements={}; kurzScores={};
  for(let i=0;i<count;i++){players.push({name:"",bonus:0,selectedOptions:[]}); kurzScores[i] = {}; }
  document.getElementById("startSection").style.display="none";
  document.getElementById("game").style.display="block";
  document.getElementById("generators").style.display = (mode === "matchplay" || mode === "kurz") ? "none" : "flex";
  renderPlayers();
  renderHoles(count,mode);
}

function resetGame(){
  document.getElementById("game").style.display="none";
  document.getElementById("startSection").style.display="block";
  document.getElementById("clubResultBox").textContent="";
  document.getElementById("formResultBox").textContent="";
  optionOwner={}; placements={}; kurzScores={};
}

function randomClub(){document.getElementById("clubResultBox").textContent=clubs[Math.floor(Math.random()*clubs.length)];}
function randomForm(){
  const f=forms[Math.floor(Math.random()*forms.length)];
  const m=f.match(/^(.*?)\s*\((.*)\)\s*$/);
  if(m){
    document.getElementById("formResultBox").textContent = m[1] + "\n" + m[2];
  } else {
    document.getElementById("formResultBox").textContent = f;
  }
}

/* RENDER PLAYERS (inkl. Matchplay/Team/Kurzspiel) */
function renderPlayers(){
  const container=document.getElementById("playersSection");
  container.innerHTML="";
  const mode=document.getElementById("mode").value;
  const count=players.length;

  if(mode==="matchplay"&&count===4){
    let wrapper=document.createElement("div");
    wrapper.className="teamWrapper";

    // Team A (Spieler 1+2)
    let t1=document.createElement("div"); t1.style.flex="1";
    t1.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <strong>Team A</strong>
        <div style="display:flex; align-items:center; gap:12px;"><div id="status-team1" class="badge tied">TIED</div><div id="teamA-total" class="score-square score-zero-white">0</div></div>
      </div>
      <div style="margin-top:8px; display:flex; gap:12px;">
        <div style="flex:1;">
          Spieler 1:<br><input type="text" oninput="players[0].name=this.value;updateUI();">
          <div class="optionList" id="opt0" style="display:flex; align-items:center;">
            <div style="flex:1;" id="optListInner0"></div>
            <div id="bonus-square-0" class="score-small score-zero-white">0</div>
          </div>
          <div class="placementTable" id="placement0"></div>
        </div>
        <div style="flex:1;">
          Spieler 2:<br><input type="text" oninput="players[1].name=this.value;updateUI();">
          <div class="optionList" id="opt1" style="display:flex; align-items:center;">
            <div style="flex:1;" id="optListInner1"></div>
            <div id="bonus-square-1" class="score-small score-zero-white">0</div>
          </div>
          <div class="placementTable" id="placement1"></div>
        </div>
      </div>
      <div style="margin-top:10px;">
        <div style="text-align:center; font-weight:700; margin-bottom:6px;">Bahnen 1–9</div>
        <div id="teamA-holes-1" class="hole-row" style="margin-bottom:6px;"></div>
        <div style="text-align:center; font-weight:700; margin:6px 0 6px;">Bahnen 10–18</div>
        <div id="teamA-holes-2" class="hole-row"></div>
      </div>
    `;

    // Team B (Spieler 3+4)
    let t2=document.createElement("div"); t2.style.flex="1";
    t2.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <strong>Team B</strong>
        <div style="display:flex; align-items:center; gap:12px;"><div id="status-team2" class="badge tied">TIED</div><div id="teamB-total" class="score-square score-zero-white">0</div></div>
      </div>
      <div style="margin-top:8px; display:flex; gap:12px;">
        <div style="flex:1;">
          Spieler 3:<br><input type="text" oninput="players[2].name=this.value;updateUI();">
          <div class="optionList" id="opt2" style="display:flex; align-items:center;">
            <div style="flex:1;" id="optListInner2"></div>
            <div id="bonus-square-2" class="score-small score-zero-white">0</div>
          </div>
          <div class="placementTable" id="placement2"></div>
        </div>
        <div style="flex:1;">
          Spieler 4:<br><input type="text" oninput="players[3].name=this.value;updateUI();">
          <div class="optionList" id="opt3" style="display:flex; align-items:center;">
            <div style="flex:1;" id="optListInner3"></div>
            <div id="bonus-square-3" class="score-small score-zero-white">0</div>
          </div>
          <div class="placementTable" id="placement3"></div>
        </div>
      </div>
      <div style="margin-top:10px;">
        <div style="text-align:center; font-weight:700; margin-bottom:6px;">Bahnen 1–9</div>
        <div id="teamB-holes-1" class="hole-row" style="margin-bottom:6px;"></div>
        <div style="text-align:center; font-weight:700; margin:6px 0 6px;">Bahnen 10–18</div>
        <div id="teamB-holes-2" class="hole-row"></div>
      </div>
    `;

    wrapper.appendChild(t1); wrapper.appendChild(t2);
    container.appendChild(wrapper);
    // build hole circles for teams
    for(let h=1; h<=9; h++){
      const a = document.createElement('div'); a.className='hole-circle neutral'; a.id = `team1-hole-${h}`; a.textContent = h; document.getElementById('teamA-holes-1').appendChild(a);
      const b = document.createElement('div'); b.className='hole-circle neutral'; b.id = `team2-hole-${h}`; b.textContent = h; document.getElementById('teamB-holes-1').appendChild(b);
    }
    for(let h=10; h<=18; h++){
      const a = document.createElement('div'); a.className='hole-circle neutral'; a.id = `team1-hole-${h}`; a.textContent = h; document.getElementById('teamA-holes-2').appendChild(a);
      const b = document.createElement('div'); b.className='hole-circle neutral'; b.id = `team2-hole-${h}`; b.textContent = h; document.getElementById('teamB-holes-2').appendChild(b);
    }

    updateUI();
    return;
  }

  if(mode==="matchplay"&&count===2){
    let row=document.createElement("div");row.className="centerRow";
    for(let i=0;i<2;i++){
      let div=document.createElement("div");div.className="playerCard";
      div.innerHTML=`<div style="display:flex; align-items:center; justify-content:space-between;">
        <div><strong>Spieler ${i+1}</strong><br><input type="text" oninput="players[${i}].name=this.value;updateUI();"></div>
        <div id="score${i}" class="score-square score-zero-white">0</div>
      </div>
      <div style="margin-top:8px;"><div id="status${i}" class="badge tied">TIED</div></div>
      <div style="margin-top:10px;">
        <div style="text-align:center; font-weight:700; margin-bottom:6px;">Bahnen 1–9</div>
        <div id="player${i}-holes-1" class="hole-row" style="margin-bottom:6px;"></div>
        <div style="text-align:center; font-weight:700; margin:6px 0 6px;">Bahnen 10–18</div>
        <div id="player${i}-holes-2" class="hole-row"></div>
      </div>
      <div class="placementTable" id="placement${i}"></div>`;
      row.appendChild(div);
    }container.appendChild(row);
    // create hole circles for each player
    for(let i=0;i<2;i++){
      for(let h=1; h<=9; h++){ const el = document.createElement('div'); el.className='hole-circle neutral'; el.id=`p${i}-hole-${h}`; el.textContent=h; document.getElementById(`player${i}-holes-1`).appendChild(el); }
      for(let h=10; h<=18; h++){ const el = document.createElement('div'); el.className='hole-circle neutral'; el.id=`p${i}-hole-${h}`; el.textContent=h; document.getElementById(`player${i}-holes-2`).appendChild(el); }
    }
    updateUI();
    return;
  }

  // Kurzspiel mode or Einzel/normal strokeplay rendering
  let row=document.createElement("div");row.className="centerRow";
  players.forEach((p,i)=>{
    let div=document.createElement("div");div.className="playerCard";
    div.innerHTML=`<div style="display:flex; align-items:center; justify-content:space-between;">
      <div>Spieler ${i+1}:<br><input type="text" oninput="players[${i}].name=this.value;updateUI();"></div>
      <div id="score${i}" class="score-square score-zero-white">0</div>
    </div>
    <div style="margin-top:6px;">
      <select onchange="addOption(${i},this.value)"><option value="">Option wählen…</option>${options.map(o=>`<option value="${o.name}">${o.name} (${o.value>0?'+':''}${o.value})</option>`).join('')}</select>
    </div>
    <div class="optionList" id="opt${i}" style="display:flex; align-items:center;">
      <div id="optListInner${i}" style="flex:1;"></div>
      <div id="bonus-square-${i}" class="score-small score-zero-white">0</div>
    </div>
    <div class="placementTable" id="placement${i}"></div>`;
    row.appendChild(div);
  });container.appendChild(row);
  updateUI();
}

/* ADD OPTION */
function addOption(playerIndex,optionName){
  if(!optionName)return;
  const opt=options.find(o=>o.name===optionName);
  if(!opt)return;
  if(optionOwner[optionName]!==undefined){
    let prevIndex=optionOwner[optionName];
    let prev=players[prevIndex];
    prev.bonus-=opt.value;
    prev.selectedOptions=prev.selectedOptions.filter(o=>o.name!==optionName);
  }
  let p=players[playerIndex];
  if(!p.selectedOptions.find(o=>o.name===opt.name)){
    p.selectedOptions.push(opt); p.bonus+=opt.value; optionOwner[optionName]=playerIndex;
  }
  updateUI();
}

/* RENDER HOLES (selects etc.) */
function renderHoles(count,mode){
  const holesDiv=document.getElementById("holes");
  holesDiv.innerHTML="";
  for(let h=1;h<=18;h++){
    let wrapper=document.createElement("div");
    wrapper.className="holeCard";

    let headline=document.createElement("div");
    headline.className="holeTitle";
    headline.textContent=`Bahn ${h}`;
    wrapper.appendChild(headline);

    let controls=document.createElement("div");
    controls.className="holeControls";
    if(count==4 && mode==="einzel") controls.classList.add("small-gap");

    if(mode==="matchplay"&&count===4){
      controls.innerHTML=`
        <div>
          Team 1<br>
          <select id="sel-${h}-team-1"
            onchange="setPlacementMatchplayTeam(${h},1,this.value)">
            <option value="">-</option>
            <option value="Gewonnen">Gewonnen</option>
            <option value="Verloren">Verloren</option>
            <option value="Geteilt">Geteilt</option>
          </select>
        </div>
        <div>
          Team 2<br>
          <select id="sel-${h}-team-2"
            onchange="setPlacementMatchplayTeam(${h},2,this.value)">
            <option value="">-</option>
            <option value="Gewonnen">Gewonnen</option>
            <option value="Verloren">Verloren</option>
            <option value="Geteilt">Geteilt</option>
          </select>
        </div>`;
    } else if(mode==="matchplay"&&count===2){
      controls.innerHTML=`
        <div>
          Spieler 1<br>
          <select id="sel-${h}-0"
            onchange="setPlacementMatchplay(${h},0,this.value)">
            <option value="">-</option>
            <option value="Gewonnen">Gewonnen</option>
            <option value="Verloren">Verloren</option>
            <option value="Geteilt">Geteilt</option>
          </select>
        </div>
        <div>
          Spieler 2<br>
          <select id="sel-${h}-1"
            onchange="setPlacementMatchplay(${h},1,this.value)">
            <option value="">-</option>
            <option value="Gewonnen">Gewonnen</option>
            <option value="Verloren">Verloren</option>
            <option value="Geteilt">Geteilt</option>
          </select>
        </div>`;
    } else if(mode==="kurz"){
      controls.innerHTML = `<div style="font-size:0.9em; color:#666;">Kurzspiel-Competition: Eingabe in Scorecards</div>`;
    } else {
      let html='';
      for(let i=0;i<count;i++){
        if(count==2){
          html+=`<label class="small-select-label">${i+1}:<select id="sel-${h}-${i}" onchange="setPlacement(${h},${i},this.value)"><option value="">-</option><option value="1">1. Platz</option><option value="2">2. Platz</option><option value="T">T (geteilt)</option></select></label>`;
        }else{
          html+=`<label class="small-select-label">${i+1}:<select id="sel-${h}-${i}" onchange="setPlacement(${h},${i},this.value)"><option value="">-</option><option value="1">1. Platz</option><option value="2">2. Platz</option>${count>=3?'<option value="3">3. Platz</option>':''}${count==4?'<option value="4">4. Platz</option>':''}</select></label>`;
        }
      }
      controls.innerHTML=html;
    }

    wrapper.appendChild(controls);
    holesDiv.appendChild(wrapper);
  }
  document.getElementById("holesSection").style.display="block";

  if(document.getElementById("mode").value === "kurz"){
    renderKurzspielScorecards();
    document.getElementById("holesSection").style.display = "none";
  }
}

/* SET PLACEMENT for strokeplay */
function setPlacement(hole,playerIndex,place){
  const count=players.length;
  if(count==2&&place==="T"){
    for(let i=0;i<count;i++){
      placements[`${hole}-${i}`]={points:0,label:"T"};
      let sel=document.getElementById(`sel-${hole}-${i}`);if(sel)sel.value="T";
    }
    // if matchplay with teams, recompute team outcome automatically
    if(document.getElementById("mode").value==="matchplay" && players.length===4){
      computeTeamScoringFromIndividuals();
    }
    updateUI();return;
  }
  let num=parseInt(place);if(isNaN(num))return;
  let points=0;
  if(count==4){if(num==1)points=+2;if(num==2)points=+1;if(num==3)points=-1;if(num==4)points=-2;}
  else if(count==3){if(num==1)points=+1;if(num==2)points=0;if(num==3)points=-1;}
  else if(count==2){if(num==1)points=+1;if(num==2)points=-1;}
  placements[`${hole}-${playerIndex}`]={points:points,label:num};
  // If in 4-player matchplay, recompute team outcome automatically
  if(document.getElementById("mode").value==="matchplay" && players.length===4){
    computeTeamScoringFromIndividuals();
  }
  updateUI();
}

/* SET PLACEMENT for 2-player matchplay (selects) */
function setPlacementMatchplay(hole,playerIndex,value){
  if(value===""){ delete placements[`${hole}-0`]; delete placements[`${hole}-1`]; updateSelectReflect(hole); updateUI(); return; }
  if(value==="Gewonnen"){ placements[`${hole}-0`]=(playerIndex===0)?{result:"Gewonnen"}:{result:"Verloren"};
    placements[`${hole}-1`]=(playerIndex===0)?{result:"Verloren"}:{result:"Gewonnen"}; }
  else if(value==="Verloren"){ placements[`${hole}-0`]=(playerIndex===0)?{result:"Verloren"}:{result:"Gewonnen"};
    placements[`${hole}-1`]=(playerIndex===0)?{result:"Gewonnen"}:{result:"Verloren"}; }
  else if(value==="Geteilt"){ placements[`${hole}-0`]={result:"Geteilt"}; placements[`${hole}-1`]={result:"Geteilt"}; }
  updateSelectReflect(hole);
  updateUI();
}

/* SET PLACEMENT for Team selects (kept, but automatic computation from individuals has priority) */
function setPlacementMatchplayTeam(hole,team,value){
  if(value===""){ delete placements[`${hole}-team1`]; delete placements[`${hole}-team2`]; updateSelectReflectTeam(hole); updateUI(); return;}
  if(value==="Gewonnen"){ placements[`${hole}-team1`]=(team===1)?{result:"Gewonnen"}:{result:"Verloren"};
    placements[`${hole}-team2`]=(team===1)?{result:"Verloren"}:{result:"Gewonnen"}; }
  else if(value==="Verloren"){ placements[`${hole}-team1`]=(team===1)?{result:"Verloren"}:{result:"Gewonnen"};
    placements[`${hole}-team2`]=(team===1)?{result:"Gewonnen"}:{result:"Verloren"}; }
  else if(value==="Geteilt"){ placements[`${hole}-team1`]={result:"Geteilt"}; placements[`${hole}-team2`]={result:"Geteilt"}; }
  updateSelectReflectTeam(hole);
  // Also ensure individual-based auto-overwrite doesn't conflict: recompute using team selects if no individuals set
  computeTeamScoringFromIndividuals();
  updateUI();
}

function updateSelectReflect(hole){
  if(document.getElementById(`sel-${hole}-0`) && placements[`${hole}-0`]) document.getElementById(`sel-${hole}-0`).value = placements[`${hole}-0`].result;
  if(document.getElementById(`sel-${hole}-1`) && placements[`${hole}-1`]) document.getElementById(`sel-${hole}-1`).value = placements[`${hole}-1`].result;
}
function updateSelectReflectTeam(hole){
  if(document.getElementById(`sel-${hole}-team-1`) && placements[`${hole}-team1`]) document.getElementById(`sel-${hole}-team-1`).value = placements[`${hole}-team1`].result;
  if(document.getElementById(`sel-${hole}-team-2`) && placements[`${hole}-team2`]) document.getElementById(`sel-${hole}-team-2`).value = placements[`${hole}-team2`].result;
}

/* AUTOMATIC TEAM AUSWERTUNG basierend auf individuellen Platzierungen
   Team A = Spieler 0 & 1, Team B = Spieler 2 & 3.
   Für jedes Loch: bestes (kleinste) Platzierungslabel eines Teammitglieds entscheidet.
   numeric < numeric -> win; equal -> tie; missing entries -> ignored.
   Assigned team result stored in placements[`${h}-team1`] & `${h}-team2`.
*/
function computeTeamScoringFromIndividuals(){
  // Only valid when 4 players exist and mode is matchplay
  if(players.length !== 4) return;
  for(let h=1; h<=18; h++){
    // Collect labels for each team
    let bestA = null; // numeric or 'T'
    let bestB = null;
    // players 0 and 1 -> A; 2 and 3 -> B
    for(let pi=0; pi<4; pi++){
      const ent = placements[`${h}-${pi}`];
      if(!ent) continue;
      const lab = ent.label;
      if(lab === "T"){
        if(pi<=1){ if(bestA===null) bestA='T'; }
        else { if(bestB===null) bestB='T'; }
      } else if(typeof lab === 'number'){
        if(pi<=1){
          if(bestA===null || bestA==='T' || lab < bestA) bestA = lab;
        } else {
          if(bestB===null || bestB==='T' || lab < bestB) bestB = lab;
        }
      }
    }
    // Determine team result
    if(bestA === null && bestB === null){
      // no data -> keep any existing team-select result (do nothing) OR clear results
      // We'll clear to avoid stale state
      delete placements[`${h}-team1`];
      delete placements[`${h}-team2`];
    } else {
      let resA=null, resB=null;
      if(bestA === 'T' && bestB === 'T'){ resA='Geteilt'; resB='Geteilt'; }
      else if(bestA === 'T' && typeof bestB === 'number'){ resA='Verloren'; resB='Gewonnen'; }
      else if(bestB === 'T' && typeof bestA === 'number'){ resA='Gewonnen'; resB='Verloren'; }
      else if(typeof bestA === 'number' && typeof bestB === 'number'){
        if(bestA < bestB){ resA='Gewonnen'; resB='Verloren'; }
        else if(bestA === bestB){ resA='Geteilt'; resB='Geteilt'; }
        else { resA='Verloren'; resB='Gewonnen'; }
      } else if(typeof bestA === 'number' && bestB === null){ resA='Gewonnen'; resB='Verloren'; }
      else if(typeof bestB === 'number' && bestA === null){ resA='Verloren'; resB='Gewonnen'; }
      else { resA='Geteilt'; resB='Geteilt'; }
      placements[`${h}-team1`] = { result: resA };
      placements[`${h}-team2`] = { result: resB };
    }
  }
  // After updating all holes, update team circle visuals and totals
  for(let h=1; h<=18; h++){
    updateTeamCircles(h);
  }
  // Update team totals
  let totalA=0, totalB=0;
  for(let h=1; h<=18; h++){
    const a = placements[`${h}-team1`];
    const b = placements[`${h}-team2`];
    if(a && a.result==='Gewonnen') totalA++;
    else if(a && a.result==='Verloren') totalA--;
    if(b && b.result==='Gewonnen') totalB++;
    else if(b && b.result==='Verloren') totalB--;
  }
  const tA = document.getElementById("teamA-total"), tB = document.getElementById("teamB-total");
  if(tA) { tA.textContent = totalA; tA.className = (totalA>0? "score-square score-positive" : totalA<0? "score-square score-negative":"score-square score-neutral"); }
  if(tB) { tB.textContent = totalB; tB.className = (totalB>0? "score-square score-positive" : totalB<0? "score-square score-negative":"score-square score-neutral"); }
}

/* Helper: update visual class for team circles for a given hole */
function updateTeamCircles(hole){
  const a = placements[`${hole}-team1`];
  const b = placements[`${hole}-team2`];
  const elA = document.getElementById(`team1-hole-${hole}`);
  const elB = document.getElementById(`team2-hole-${hole}`);
  if(elA){
    if(a && a.result === "Gewonnen") { elA.className='hole-circle win'; }
    else if(a && a.result === "Verloren") { elA.className='hole-circle lose'; }
    else if(a && a.result === "Geteilt") { elA.className='hole-circle tie'; }
    else { elA.className='hole-circle neutral'; }
  }
  if(elB){
    if(b && b.result === "Gewonnen") { elB.className='hole-circle win'; }
    else if(b && b.result === "Verloren") { elB.className='hole-circle lose'; }
    else if(b && b.result === "Geteilt") { elB.className='hole-circle tie'; }
    else { elB.className='hole-circle neutral'; }
  }
}

/* UPDATE UI general (non-matchplay) */
function updateUI(){
  const mode=document.getElementById("mode").value;
  if(mode==="matchplay"){ updateMatchplayUI(); return; }
  if(mode==="kurz"){ updateKurzspielTotals(); return; }
  players.forEach((p,i)=>{
    // sum placements
    let placementSum=0;
    for(let h=1;h<=18;h++){
      let key=`${h}-${i}`;
      if(placements[key]!==undefined && placements[key].points!==undefined){
        placementSum+=placements[key].points;
      }
    }
    const total=p.bonus+placementSum;
    const scoreEl = document.getElementById("score"+i);
    if(scoreEl){
      scoreEl.textContent = total;
      if(total>0){ scoreEl.className = "score-square score-positive"; }
      else if(total<0){ scoreEl.className = "score-square score-negative"; }
      else { scoreEl.className = "score-square score-neutral"; }
    }
    const optInner = document.getElementById(`optListInner${i}`);
    if(optInner){ optInner.innerHTML = p.selectedOptions.map(o=>`${o.name} (${o.value>0?'+':''}${o.value})`).join('<br>'); }
    const bonusSquare = document.getElementById(`bonus-square-${i}`);
    if(bonusSquare){
      const b = p.bonus || 0;
      bonusSquare.textContent = b;
      if(b>0) bonusSquare.className = "score-small score-positive";
      else if(b<0) bonusSquare.className = "score-small score-negative";
      else bonusSquare.className = "score-small score-zero-white";
    }
    const placementDiv = document.getElementById("placement"+i);
    if(placementDiv){
      let placementHtml='';
      for(let h=1;h<=18;h++){
        let key=`${h}-${i}`;
        if(placements[key]!==undefined && placements[key].points!==undefined){
          placementHtml+=`Bahn ${h}: ${placements[key].points} Punkte<br>`;
        }
      }
      placementDiv.innerHTML = placementHtml;
    }
  });
}

/* MATCHPLAY UI update for 2 and 4 players */
function updateMatchplayUI(){
  const count=players.length;
  if(count===2){
    // compute net up
    let up=0; let played=0;
    for(let h=1;h<=18;h++){
      if(placements[`${h}-0`] && placements[`${h}-0`].result){
        played++;
        if(placements[`${h}-0`].result==="Gewonnen") up++;
        else if(placements[`${h}-0`].result==="Verloren") up--;
      }
    }
    let remaining = 18-played;
    let status0="", status1="", class0="", class1="";
    if(up===0){ status0=status1="TIED"; class0=class1="badge tied"; }
    else if(up>0){
      if(up>remaining){ status0=`${up} & ${remaining}`; status1="DOWN"; class0="badge up"; class1="badge down"; }
      else { status0=`${up} UP`; status1=`${Math.abs(up)} DOWN`; class0="badge up"; class1="badge down"; }
    } else {
      let abs=Math.abs(up);
      if(abs>remaining){ status1=`${abs} & ${remaining}`; status0="DOWN"; class1="badge up"; class0="badge down"; }
      else { status1=`${abs} UP`; status0=`${abs} DOWN`; class1="badge up"; class0="badge down"; }
    }
    if(document.getElementById("status0")){ document.getElementById("status0").textContent=status0; document.getElementById("status0").className=class0; }
    if(document.getElementById("status1")){ document.getElementById("status1").textContent=status1; document.getElementById("status1").className=class1; }

    // update hole circles & placements
    for(let h=1;h<=18;h++){
      const e0 = placements[`${h}-0`];
      const e1 = placements[`${h}-1`];
      const el0 = document.getElementById(`p0-hole-${h}`);
      const el1 = document.getElementById(`p1-hole-${h}`);
      if(!el0 || !el1) continue;
      if(e0 && e0.result){
        if(e0.result==="Gewonnen"){ el0.className='hole-circle win'; el1.className='hole-circle lose'; }
        else if(e0.result==="Verloren"){ el0.className='hole-circle lose'; el1.className='hole-circle win'; }
        else { el0.className='hole-circle tie'; el1.className='hole-circle tie'; }
      } else { el0.className='hole-circle neutral'; el1.className='hole-circle neutral'; }
    }

    // totals display net
    const s0 = document.getElementById("score0"), s1 = document.getElementById("score1");
    if(s0 && s1){
      s0.textContent = up; s1.textContent = -up;
      if(up>0){ s0.className="score-square score-positive"; s1.className="score-square score-negative"; }
      else if(up<0){ s0.className="score-square score-negative"; s1.className="score-square score-positive"; }
      else { s0.className="score-square score-neutral"; s1.className="score-square score-neutral"; }
    }
    // placement tables
    for(let i=0;i<2;i++){
      let placementHtml='';
      for(let h=1;h<=18;h++){
        if(placements[`${h}-${i}`] && placements[`${h}-${i}`].result) placementHtml += `Bahn ${h}: ${placements[`${h}-${i}`].result}<br>`;
      }
      const placementDiv = document.getElementById("placement"+i);
      if(placementDiv) placementDiv.innerHTML = placementHtml;
    }
    return;
  }

  if(count===4){
    // First compute automatic team scoring from individuals
    computeTeamScoringFromIndividuals();
    // compute up value from team1 results
    let up=0; let played=0;
    for(let h=1;h<=18;h++){
      if(placements[`${h}-team1`] && placements[`${h}-team1`].result){
        played++;
        if(placements[`${h}-team1`].result==="Gewonnen") up++;
        else if(placements[`${h}-team1`].result==="Verloren") up--;
      }
    }
    let remaining=18-played;
    let s1="", s2="", c1="", c2="";
    if(up===0){ s1=s2="TIED"; c1=c2="badge tied"; }
    else if(up>0){
      if(up>remaining){ s1=`${up} & ${remaining}`; s2="DOWN"; c1="badge up"; c2="badge down"; }
      else { s1=`${up} UP`; s2=`${Math.abs(up)} DOWN`; c1="badge up"; c2="badge down"; }
    } else {
      let abs=Math.abs(up);
      if(abs>remaining){ s2=`${abs} & ${remaining}`; s1="DOWN"; c2="badge up"; c1="badge down"; }
      else { s2=`${abs} UP`; s1=`${abs} DOWN`; c2="badge up"; c1="badge down"; }
    }
    if(document.getElementById("status-team1")){ document.getElementById("status-team1").textContent = s1; document.getElementById("status-team1").className = c1; }
    if(document.getElementById("status-team2")){ document.getElementById("status-team2").textContent = s2; document.getElementById("status-team2").className = c2; }

    // Update team circle visuals already done in computeTeamScoringFromIndividuals via updateTeamCircles

    // Update per-player placement tables and bonus squares
    for(let i=0;i<4;i++){
      const bonusSquare = document.getElementById(`bonus-square-${i}`);
      if(bonusSquare){
        const b = players[i].bonus || 0;
        bonusSquare.textContent = b;
        if(b>0) bonusSquare.className = "score-small score-positive";
        else if(b<0) bonusSquare.className = "score-small score-negative";
        else bonusSquare.className = "score-small score-zero-white";
      }
      let placementHtml='';
      for(let h=1;h<=18;h++){
        if(placements[`${h}-${i}`] && placements[`${h}-${i}`].points!==undefined) placementHtml += `Bahn ${h}: ${placements[`${h}-${i}`].points} Punkte<br>`;
      }
      const placementDiv = document.getElementById("placement"+i);
      if(placementDiv) placementDiv.innerHTML = placementHtml;
    }
    return;
  }
}

/* KURZSPIEL: render scorecards per player */
function renderKurzspielScorecards(){
  const container=document.getElementById("playersSection");
  container.innerHTML = ""; // replace with scorecards
  const count = players.length;
  const par = parseInt(document.getElementById("parValue").value) || 2;

  for(let i=0;i<count;i++){
    let card = document.createElement("div");
    card.className = "playerCard";
    card.style.minWidth = "300px";
    card.innerHTML = `<div style="display:flex; align-items:center; justify-content:space-between;">
      <div><strong>Spieler ${i+1}</strong><br><input type="text" oninput="players[${i}].name=this.value;updateKurzspielTotals();" placeholder="Name (optional)"></div>
      <div id="kurz-total-${i}" class="score-square score-zero-white">0</div>
    </div>
    <div style="margin-top:8px; text-align:center; font-weight:700;">Bahn Ergebnisse</div>
    <div style="margin-top:8px; display:flex; flex-direction:column; gap:8px;">
      <div class="hole-row" id="k${i}-holes-1"></div>
      <div class="hole-row" id="k${i}-holes-2"></div>
    </div>
    <div style="margin-top:8px; text-align:center;">
      <button onclick="clearKurzSpielPlayer(${i})">Reset Spieler ${i+1}</button>
    </div>`;

    container.appendChild(card);

    for(let h=1; h<=9; h++){
      const el = document.createElement('div');
      el.className = 'kurz-circle';
      el.id = `k${i}-hole-${h}`;
      el.textContent = '0';
      el.style.cursor = 'pointer';
      el.addEventListener('click', () => { promptKurzInput(i, h); });
      document.getElementById(`k${i}-holes-1`).appendChild(el);
    }
    for(let h=10; h<=18; h++){
      const el = document.createElement('div');
      el.className = 'kurz-circle';
      el.id = `k${i}-hole-${h}`;
      el.textContent = '0';
      el.style.cursor = 'pointer';
      el.addEventListener('click', () => { promptKurzInput(i, h); });
      document.getElementById(`k${i}-holes-2`).appendChild(el);
    }
  }

  const info = document.createElement('div');
  info.style.width='100%';
  info.style.textAlign='center';
  info.style.marginTop='12px';
  info.innerHTML = `<div style="display:inline-block; background:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 3px 8px rgba(0,0,0,0.06);">
    PAR für alle Bahnen: <strong>${par}</strong>
    <div style="margin-top:8px; font-size:0.9em; color:#555;">Klicke auf einen Kreis, trage die Zahl ein (ganze Zahl). Farben ändern sich automatisch entsprechend PAR.</div>
  </div>`;
  document.getElementById("game").appendChild(info);
}

function promptKurzInput(playerIndex, holeNumber){
  const current = (kurzScores[playerIndex] && kurzScores[playerIndex][holeNumber] !== undefined) ? kurzScores[playerIndex][holeNumber] : 0;
  const val = prompt(`Spieler ${playerIndex+1} - Bahn ${holeNumber} Ergebnis (Zahl):`, current);
  if(val === null) return;
  const n = parseInt(val);
  if(isNaN(n)) { alert("Bitte eine gültige ganze Zahl eingeben."); return; }
  kurzScores[playerIndex][holeNumber] = n;
  updateKurzspielCell(playerIndex, holeNumber);
  updateKurzspielTotals();
}

function updateKurzspielCell(playerIndex, holeNumber){
  const par = parseInt(document.getElementById("parValue").value) || 2;
  const el = document.getElementById(`k${playerIndex}-hole-${holeNumber}`);
  if(!el) return;
  const val = kurzScores[playerIndex][holeNumber] || 0;
  el.textContent = val;
  const diff = val - par;
  el.className = 'kurz-circle';
  if(val === 0){
    el.style.background = '#fff'; el.style.color='#000'; el.style.borderColor='#000';
  } else {
    el.style.borderColor='transparent';
    if(diff <= -2){ el.classList.add('kurz-orange'); el.style.background='orange'; el.style.color='#fff'; }
    else if(diff === -1){ el.classList.add('kurz-yellow'); el.style.background='yellow'; el.style.color='#000'; }
    else if(diff === 0){ el.classList.add('kurz-blue'); el.style.background='#2b7cff'; el.style.color='#fff'; }
    else if(diff === 1){ el.classList.add('kurz-red'); el.style.background='#d9534f'; el.style.color='#fff'; }
    else if(diff === 2){ el.classList.add('kurz-purple'); el.style.background='purple'; el.style.color='#fff'; }
    else if(diff >= 3){ el.classList.add('kurz-black'); el.style.background='#000'; el.style.color='#fff'; }
    else { el.style.background='#fff'; el.style.color='#000'; }
  }
}

function updateKurzspielTotals(){
  const count = players.length;
  for(let i=0;i<count;i++){
    let total = 0;
    for(let h=1; h<=18; h++){
      if(kurzScores[i] && kurzScores[i][h] !== undefined) total += kurzScores[i][h];
    }
    const totalEl = document.getElementById(`kurz-total-${i}`);
    if(totalEl){
      totalEl.textContent = total;
      if(total>0) totalEl.className = "score-square score-positive";
      else if(total<0) totalEl.className = "score-square score-negative";
      else totalEl.className = "score-square score-neutral";
    }
    for(let h=1; h<=18; h++){
      if(kurzScores[i] && kurzScores[i][h] !== undefined) updateKurzspielCell(i,h);
      else { const el=document.getElementById(`k${i}-hole-${h}`); if(el){ el.textContent='0'; el.className='kurz-circle'; el.style.background='#fff'; el.style.color='#000'; el.style.borderColor='#000'; } }
    }
  }
}

function clearKurzSpielPlayer(i){
  kurzScores[i] = {};
  for(let h=1; h<=18; h++){
    const el = document.getElementById(`k${i}-hole-${h}`);
    if(el){ el.textContent = '0'; el.className='kurz-circle'; el.style.background='#fff'; el.style.color='#000'; el.style.borderColor='#000'; }
  }
  updateKurzspielTotals();
}

/* Utility: initial setup */
updateModeOptions();
</script>
</body>
</html>
