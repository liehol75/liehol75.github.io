<!doctype html>
<meta charset="utf-8">
<title>Golf-Tool — Zufall, Optionen & Scoring</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; --accent:#0a84ff}
  body{margin:0;padding:12px;background:#f6f7fb;color:#111}
  header{display:flex;align-items:center;gap:12px}
  h1{font-size:18px;margin:0}
  .card{background:#fff;border-radius:10px;padding:12px;margin:10px 0;box-shadow:0 1px 3px rgba(0,0,0,.08)}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  button{padding:10px;border-radius:8px;background:var(--accent);color:#fff;border:0;font-weight:600}
  button.secondary{background:#eee;color:#111}
  .big{font-size:20px;padding:16px}
  .players{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
  .player{border:1px solid #eee;padding:8px;border-radius:8px}
  label{font-size:13px;color:#444}
  input[type=text]{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd}
  select{padding:8px;border-radius:6px;border:1px solid #ddd}
  .opt-list{display:flex;flex-direction:column;gap:6px}
  .small{font-size:13px;padding:6px}
  .muted{color:#666;font-size:13px}
  .score{font-weight:800;font-size:18px}
  footer{margin-top:14px;text-align:center;color:#666;font-size:13px}
  .chip{background:#efefef;padding:6px;border-radius:999px}
  .options-editor{display:grid;grid-template-columns:1fr 80px 80px;gap:6px}
  @media (max-width:420px){.players{grid-template-columns:1fr}}
</style>
<div id=app>
  <header><h1>Golf-Tool (Zufall & Scoring)</h1></header>

  <div id=setup class="card">
    <div class=row>
      <div>
        <label><strong>Spieleranzahl</strong></label>
        <select id=numPlayers>
          <option value=2>2 Spieler</option>
          <option value=3>3 Spieler</option>
          <option value=4 selected>4 Spieler</option>
        </select>
      </div>
      <div>
        <label><strong>Modus</strong></label><br>
        <select id=mode>
          <option value="einzel">Einzel</option>
          <option value="team">Team (Paare: 1+2 vs 3+4)</option>
        </select>
      </div>
      <div style="min-width:180px">
        <label><strong>Spielernamen</strong></label>
        <div><input id=p1 placeholder="Spieler 1"></div>
        <div><input id=p2 placeholder="Spieler 2"></div>
        <div><input id=p3 placeholder="Spieler 3"></div>
        <div><input id=p4 placeholder="Spieler 4"></div>
      </div>
    </div>
    <div style="margin-top:10px">
      <button id=startBtn">Spiel starten</button>
      <button class="secondary" id=loadBtn>Gespeicherten Stand laden</button>
    </div>
  </div>

  <div id=main style="display:none">
    <div class=row>
      <div style="flex:1" class="card">
        <div><strong>Zufall: Schläger</strong></div>
        <div style="margin:8px 0" id=clubCard class="big chip">—</div>
        <div class=row>
          <button id=randClubBtn>Schläger zufällig</button>
        </div>
        <hr>
        <div><strong>Zufall: Option (20)</strong></div>
        <div style="margin:8px 0" id=optCard class="big chip">—</div>
        <div class=row>
          <button id=randOptBtn>Option zufällig wählen</button>
          <button class="secondary" id=assignRandomOpt>Automatisch zuweisen</button>
        </div>
      </div>

      <div style="flex:1" class="card">
        <div><strong>Spieler & Punkte</strong></div>
        <div id=playersArea class="players" style="margin-top:10px"></div>

        <div style="margin-top:10px">
          <button id=holeBtn>Bahn erfassen</button>
          <button class="secondary" id=undoHole>Letzte Bahn rückgängig</button>
          <button class="secondary" id=editOptionsBtn>Optionen bearbeiten</button>
          <button class="secondary" id=newRound>Neue Runde</button>
        </div>
        <div class=muted id=roundInfo>Runde: 0 Bahnen</div>
      </div>
    </div>

    <div class=card id=optionsEditor style="display:none">
      <strong>20 Optionen bearbeiten</strong>
      <div class=options-editor style="margin-top:8px" id=optionsGrid></div>
      <button id=saveOptions class="secondary">Speichern</button>
    </div>

    <div class=card>
      <div><strong>Verlauf (Bahn-Historie)</strong></div>
      <div id=holesList style="margin-top:8px"></div>
    </div>
    <footer>Speichere als HTML & über Safari „Zum Home-Bildschirm“ hinzufügen.</footer>
  </div>
</div>

<script>
(() => {
  const CLUBS = ["Driver","Holz 3","Holz 5","Hybrid","Eisen 4","Eisen 5","Eisen 6","Eisen 7","Eisen 8","Eisen 9","Pitching Wedge","Gap Wedge","Sand Wedge","Putter"];
  const STORAGE_KEY="golfToolState_v2";
  const defaultOptions=Array.from({length:20},(_,i)=>({id:i,label:`Option ${i+1}`,value:0}));

  let state={
    started:false,
    numPlayers:4,
    mode:"einzel",
    players:[
      {name:"Spieler 1",score:0},
      {name:"Spieler 2",score:0},
      {name:"Spieler 3",score:0},
      {name:"Spieler 4",score:0}
    ],
    options:defaultOptions.slice(),
    optionOwner:{},
    holes:[]
  };

  const $=s=>document.querySelector(s);

  function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state));render();}
  function load(){const raw=localStorage.getItem(STORAGE_KEY);if(raw){state=JSON.parse(raw);}render();}
  function recomputeScores(){
    state.players.forEach(p=>p.score=0);
    state.options.forEach(opt=>{
      const owner=state.optionOwner[opt.id];
      if(owner!=null) state.players[owner].score+=Number(opt.value)||0;
    });
    state.holes.forEach(h=>{
      h.points.forEach((pt,i)=>state.players[i].score+=pt);
    });
  }

  function renderPlayers(){
    const area=$("#playersArea");area.innerHTML="";
    for(let i=0;i<state.numPlayers;i++){
      const p=state.players[i];
      const div=document.createElement("div");
      div.className="player";
      div.innerHTML=`
        <input type=text id=name${i} value="${p.name}">
        <div class=score>${p.score}</div>
      `;
      area.appendChild(div);
    }
  }
  function renderOptionsEditor(){
    const grid=$("#optionsGrid");grid.innerHTML="";
    state.options.forEach(opt=>{
      grid.insertAdjacentHTML("beforeend",`
        <input value="${opt.label}" data-id="${opt.id}">
        <input type=text value="${opt.value}" data-id="${opt.id}-v">
        <div>${state.optionOwner[opt.id]!=null?`bei ${state.players[state.optionOwner[opt.id]].name}`:""}</div>
      `);
    });
  }
  function renderHoles(){
    $("#holesList").innerHTML="";
    state.holes.forEach(h=>{
      const line=document.createElement("div");
      line.className="chip";
      line.textContent=`Bahn ${h.holeNumber}: ${h.points.map((pt,i)=>state.players[i].name+":"+pt).join(" | ")}`;
      $("#holesList").appendChild(line);
    });
    $("#roundInfo").textContent=`Runde: ${state.holes.length} Bahnen`;
  }
  function render(){recomputeScores();renderPlayers();renderHoles();}

  $("#startBtn").addEventListener("click",()=>{
    state.numPlayers=Number($("#numPlayers").value);
    state.mode=$("#mode").value;
    for(let i=0;i<state.numPlayers;i++){
      const val=$("#p"+(i+1)).value.trim();
      if(val) state.players[i].name=val;
    }
    state.started=true;save();
    $("#setup").style.display="none";$("#main").style.display="";
  });

  $("#loadBtn").addEventListener("click",()=>{load();if(state.started){$("#setup").style.display="none";$("#main").style.display="";}else{$("#setup").style.display="";$("#main").style.display="none";}});

  $("#randClubBtn").addEventListener("click",()=>$("#clubCard").textContent=CLUBS[Math.floor(Math.random()*CLUBS.length)]);
  $("#randOptBtn").addEventListener("click",()=>{
    const opt=state.options[Math.floor(Math.random()*state.options.length)];
    $("#optCard").textContent=`${opt.label} (${opt.value})`;
  });
  $("#assignRandomOpt").addEventListener("click",()=>{
    const txt=$("#optCard").textContent;
    if(!txt||txt==="—"){alert("Erst Option wählen");return;}
    const opt=state.options.find(o=>txt.indexOf(o.label)===0);
    const p=Math.floor(Math.random()*state.numPlayers);
    state.optionOwner[opt.id]=p;save();
    alert(`${opt.label} an ${state.players[p].name}`);
  });

  $("#editOptionsBtn").addEventListener("click",()=>{const e=$("#optionsEditor");e.style.display=e.style.display==="none"?"":"none";renderOptionsEditor();});
  $("#saveOptions").addEventListener("click",()=>{
    const inputs=$("#optionsGrid").querySelectorAll("input");
    for(let i=0;i<inputs.length;i+=2){
      const id=Number(inputs[i].dataset.id);
      const label=inputs[i].value;
      const value=Number(inputs[i+1].value)||0;
      state.options[id]={id,label,value};
    }
    save();alert("Optionen gespeichert");
  });

  $("#holeBtn").addEventListener("click",()=>{
    const hnum=Number(prompt("Bahnnummer",state.holes.length+1));
    if(!hnum)return;
    if(state.mode==="team"&&state.numPlayers===4){
      const teamA=prompt("Team A (Spieler1+2): 1=gewonnen,2=verloren,T=geteilt","1");
      if(teamA===null)return;
      const teamB=(teamA==="1")?"2":(teamA==="2")?"1":"T";
      const map={1:1,2:-1,T:0};
      const ptsA=map[teamA]||0,ptsB=map[teamB]||0;
      const newPoints=[ptsA,ptsA,ptsB,ptsB];
      state.holes.push({holeNumber:hnum,points:newPoints});
    }else{
      const placements=[];
      for(let i=0;i<state.numPlayers;i++){
        const val=prompt(`Platz für ${state.players[i].name} (1..${state.numPlayers} oder T)`,`1`);
        if(val===null)return;
        placements[i]=val.toUpperCase()==="T"?"T":Number(val);
      }
      const N=state.numPlayers;
      const map=(N===4)?{1:2,2:1,3:-1,4:-2}:(N===3)?{1:1,2:0,3:-1}:{1:1,2:-1};
      const rankCount={};
      placements.forEach(p=>{if(p!=="T")rankCount[p]=(rankCount[p]||0)+1;});
      const points=[];
      for(let i=0;i<N;i++){
        const p=placements[i];
        if(p==="T"){points[i]=0;continue;}
        if(rankCount[p]>1){points[i]=0;continue;}
        points[i]=map[p]||0;
      }
      state.holes.push({holeNumber:hnum,points});
    }
    save();
  });

  $("#undoHole").addEventListener("click",()=>{state.holes.pop();save();});
  $("#newRound").addEventListener("click",()=>{if(confirm("Neue Runde?")){state={...state,started:false,holes:[],optionOwner:{},players:state.players.map((p,i)=>({name:`Spieler ${i+1}`,score:0}))};save();location.reload();}});

  document.addEventListener("input",e=>{
    if(e.target.id&&e.target.id.startsWith("name")){
      const idx=Number(e.target.id.replace("name",""));
      state.players[idx].name=e.target.value;save();
    }
  });

  load();
  if(state.started){$("#setup").style.display="none";$("#main").style.display="";}else{$("#setup").style.display="";$("#main").style.display="none";}
})();
</script>
